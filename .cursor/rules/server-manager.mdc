---
description: Server Manager Next.js development guidelines
globs: server-manager/**/*
alwaysApply: false
---

# Server Manager Rules

## Stack

- Next.js (latest) with App Router
- React 19 with TypeScript strict mode
- Tailwind CSS 4 (exclusive styling - no CSS modules, styled-components, or inline styles)
- Biome for linting/formatting (not ESLint)
- Dockerode for Docker API integration

## Core Libraries

| Library | Purpose |
|---------|---------|
| **Zod** | Schema validation for all data (forms, API responses, env vars) |
| **Zustand** | Client-side state management |
| **SWR** | Server/client state synchronization and data fetching |
| **Shadcn/ui** | Base for all UI components |

## Architecture

### Routing

- Use **App Router** exclusively (`/app` directory)
- Pages in `/app/**/page.tsx`
- Layouts in `/app/**/layout.tsx`
- API routes in `/app/api/**/route.ts`

### Validation with Zod

```ts
// Define schemas for all data structures
const serverSchema = z.object({
  id: z.string().uuid(),
  name: z.string().min(1),
  status: z.enum(['running', 'stopped', 'starting']),
});

type Server = z.infer<typeof serverSchema>;

// Validate API responses
const data = serverSchema.parse(await res.json());
```

### State Management

```ts
// Zustand for client state
import { create } from 'zustand';

const useUIStore = create<UIState>((set) => ({
  sidebarOpen: false,
  toggleSidebar: () => set((s) => ({ sidebarOpen: !s.sidebarOpen })),
}));

// SWR for server state
import useSWR from 'swr';

function useServer(id: string) {
  return useSWR(`/api/servers/${id}`, fetcher);
}
```

### Styling

- **Only use Tailwind CSS** - no other styling approaches
- Use Shadcn components as the foundation
- Extend with Tailwind utilities, never custom CSS

```tsx
// ✅ Correct
<Button className="mt-4 w-full">Submit</Button>

// ❌ Avoid
<button style={{ marginTop: '1rem' }}>Submit</button>
```

## Data Fetching Strategy

| Location | Method |
|----------|--------|
| Server Components | Direct fetch with Zod validation |
| Client Components | SWR hooks (stale-while-revalidate) |
| Mutations | SWR mutation or Server Actions |

### Server Component Fetching (Next.js)

```tsx
// Static data (cached until manual invalidation)
const data = await fetch('https://...', { cache: 'force-cache' });

// Dynamic data (refetched on every request)
const data = await fetch('https://...', { cache: 'no-store' });

// ISR (cached with revalidation interval)
const data = await fetch('https://...', { next: { revalidate: 60 } });

// Pattern: Fetch in Server Component, pass to Client Component
export default async function Page() {
  const data = await fetchData();
  return <ClientComponent data={data} />;
}
```

### SWR Best Practices

```ts
// Create reusable hooks - eliminates prop drilling
function useServerStatus(id: string) {
  return useSWR(`/api/servers/${id}/status`, fetcher, {
    refreshInterval: 5000,
    revalidateOnFocus: true,
  });
}

// Optimistic updates with rollback
mutate('/api/user', updateFn(user), {
  optimisticData: newUser,
  rollbackOnError: (error) => error.name !== 'AbortError',
});

// Populate cache from mutation response (skip revalidation)
mutate('/api/todos', updateTodo, {
  populateCache: (updated, todos) => [...todos.filter(t => t.id !== updated.id), updated],
  revalidate: false,
});
```

### Zustand Best Practices

```ts
// Typed store with curried create
interface UIState {
  sidebarOpen: boolean;
  toggleSidebar: () => void;
}

const useUIStore = create<UIState>()((set) => ({
  sidebarOpen: false,
  toggleSidebar: () => set((s) => ({ sidebarOpen: !s.sidebarOpen })),
}));

// Use selectors to prevent re-renders
const sidebarOpen = useUIStore((s) => s.sidebarOpen); // ✅

// Multiple selectors with useShallow
import { useShallow } from 'zustand/react/shallow';
const { bears, food } = useStore(useShallow((s) => ({ bears: s.bears, food: s.food })));

// Derived state (compute in selector, don't store)
const totalFood = useStore((s) => s.bears * s.foodPerBear);
```

### Zustand Slices Pattern (Large Stores)

```ts
// Split store into domain slices
const createBearSlice: StateCreator<BearSlice & FishSlice, [], [], BearSlice> = (set) => ({
  bears: 0,
  addBear: () => set((s) => ({ bears: s.bears + 1 })),
});

const useBoundStore = create<BearSlice & FishSlice>()((...a) => ({
  ...createBearSlice(...a),
  ...createFishSlice(...a),
}));
```

## Commands

```bash
cd server-manager/hyos-server-manager/next
pnpm install
pnpm dev      # Development
pnpm build    # Production build
pnpm lint     # Biome linting
pnpm format   # Biome formatting
```

## Project Conventions

- **No Python** - Use Node.js for all scripting
- **No rounded corners** - Square edges throughout (Cablefied theme)
- **Cablefied font** - Custom font from `cablefied.woff2`
- **Dotted background pattern** - Not grid pattern

## Deployment

See `.cursor/skills/deploy-server-manager/SKILL.md` for deployment workflow.
