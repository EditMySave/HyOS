services:
  # =============================================================================
  # Main Hytale Server
  # =============================================================================
  hytale:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        UID: ${UID:-1000}
        GID: ${GID:-1000}
    image: hytale-server:enterprise
    container_name: ${CONTAINER_NAME:-hytale-server}
    hostname: hytale-server
    restart: unless-stopped

    # UDP port for QUIC protocol
    ports:
      - "${SERVER_PORT:-5520}:5520/udp"

    # Environment configuration
    environment:
      # --- User Settings ---
      UID: ${UID:-1000}
      GID: ${GID:-1000}
      TZ: ${TZ:-UTC}

      # --- JVM Settings ---
      JAVA_XMS: ${JAVA_XMS:-4G}
      JAVA_XMX: ${JAVA_XMX:-8G}
      JAVA_OPTS: ${JAVA_OPTS:-}
      JVM_XX_OPTS: ${JVM_XX_OPTS:-}

      # --- GC Settings ---
      USE_G1GC: ${USE_G1GC:-true}
      USE_ZGC: ${USE_ZGC:-false}
      G1_MAX_PAUSE: ${G1_MAX_PAUSE:-200}
      G1_NEW_SIZE_PERCENT: ${G1_NEW_SIZE_PERCENT:-}
      G1_MAX_NEW_SIZE_PERCENT: ${G1_MAX_NEW_SIZE_PERCENT:-}
      G1_HEAP_REGION_SIZE: ${G1_HEAP_REGION_SIZE:-}
      ZGC_INTERVAL: ${ZGC_INTERVAL:-5}

      # --- Server Settings ---
      SERVER_PORT: "5520"
      PATCHLINE: ${PATCHLINE:-release}
      ENABLE_AOT: ${ENABLE_AOT:-true}
      AUTO_UPDATE: ${AUTO_UPDATE:-false}

      # --- Config Generation ---
      SKIP_CONFIG_GENERATION: ${SKIP_CONFIG_GENERATION:-false}
      HYTALE_CONFIG_JSON: ${HYTALE_CONFIG_JSON:-}
      SERVER_NAME: ${SERVER_NAME:-Hytale Server}
      SERVER_MOTD: ${SERVER_MOTD:-}
      SERVER_PASSWORD: ${SERVER_PASSWORD:-}
      MAX_PLAYERS: ${MAX_PLAYERS:-100}
      MAX_VIEW_RADIUS: ${MAX_VIEW_RADIUS:-32}
      DEFAULT_WORLD: ${DEFAULT_WORLD:-default}
      DEFAULT_GAMEMODE: ${DEFAULT_GAMEMODE:-Adventure}
      LOCAL_COMPRESSION: ${LOCAL_COMPRESSION:-false}
      DISPLAY_TMP_TAGS: ${DISPLAY_TMP_TAGS:-false}
      PLAYER_STORAGE_TYPE: ${PLAYER_STORAGE_TYPE:-Hytale}

      # --- Whitelist ---
      WHITELIST_ENABLED: ${WHITELIST_ENABLED:-false}
      WHITELIST_LIST: ${WHITELIST_LIST:-}
      WHITELIST_JSON: ${WHITELIST_JSON:-}

      # --- Hytale Server Options ---
      HYTALE_ACCEPT_EARLY_PLUGINS: ${HYTALE_ACCEPT_EARLY_PLUGINS:-false}
      HYTALE_ALLOW_OP: ${HYTALE_ALLOW_OP:-false}
      HYTALE_AUTH_MODE: ${HYTALE_AUTH_MODE:-}
      HYTALE_BACKUP: ${HYTALE_BACKUP:-false}
      HYTALE_BACKUP_DIR: ${HYTALE_BACKUP_DIR:-}
      HYTALE_BACKUP_FREQUENCY: ${HYTALE_BACKUP_FREQUENCY:-30}
      HYTALE_BACKUP_MAX_COUNT: ${HYTALE_BACKUP_MAX_COUNT:-}
      HYTALE_BARE: ${HYTALE_BARE:-false}
      HYTALE_BOOT_COMMAND: ${HYTALE_BOOT_COMMAND:-}
      HYTALE_DISABLE_ASSET_COMPARE: ${HYTALE_DISABLE_ASSET_COMPARE:-false}
      HYTALE_DISABLE_CPB_BUILD: ${HYTALE_DISABLE_CPB_BUILD:-false}
      HYTALE_DISABLE_FILE_WATCHER: ${HYTALE_DISABLE_FILE_WATCHER:-false}
      HYTALE_DISABLE_SENTRY: ${HYTALE_DISABLE_SENTRY:-false}
      HYTALE_EARLY_PLUGINS: ${HYTALE_EARLY_PLUGINS:-}
      HYTALE_EVENT_DEBUG: ${HYTALE_EVENT_DEBUG:-false}
      HYTALE_FORCE_NETWORK_FLUSH: ${HYTALE_FORCE_NETWORK_FLUSH:-}
      HYTALE_GENERATE_SCHEMA: ${HYTALE_GENERATE_SCHEMA:-false}
      HYTALE_LOG: ${HYTALE_LOG:-}
      HYTALE_MIGRATE_WORLDS: ${HYTALE_MIGRATE_WORLDS:-}
      HYTALE_MIGRATIONS: ${HYTALE_MIGRATIONS:-}
      HYTALE_MODS: ${HYTALE_MODS:-}
      HYTALE_OWNER_NAME: ${HYTALE_OWNER_NAME:-}
      HYTALE_PREFAB_CACHE: ${HYTALE_PREFAB_CACHE:-}
      HYTALE_SHUTDOWN_AFTER_VALIDATE: ${HYTALE_SHUTDOWN_AFTER_VALIDATE:-false}
      HYTALE_SINGLEPLAYER: ${HYTALE_SINGLEPLAYER:-false}
      HYTALE_TRANSPORT: ${HYTALE_TRANSPORT:-}
      HYTALE_UNIVERSE: ${HYTALE_UNIVERSE:-}
      HYTALE_VALIDATE_ASSETS: ${HYTALE_VALIDATE_ASSETS:-false}
      HYTALE_VALIDATE_PREFABS: ${HYTALE_VALIDATE_PREFABS:-}
      HYTALE_VALIDATE_WORLD_GEN: ${HYTALE_VALIDATE_WORLD_GEN:-false}
      HYTALE_WORLD_GEN: ${HYTALE_WORLD_GEN:-}
      HYTALE_EXTRA_ARGS: ${HYTALE_EXTRA_ARGS:-}

      # --- Token Injection (Hosting Provider Mode) ---
      HYTALE_SERVER_SESSION_TOKEN: ${HYTALE_SERVER_SESSION_TOKEN:-}
      HYTALE_SERVER_IDENTITY_TOKEN: ${HYTALE_SERVER_IDENTITY_TOKEN:-}
      HYTALE_OWNER_UUID: ${HYTALE_OWNER_UUID:-}

      # --- Debug ---
      DEBUG: ${DEBUG:-false}
      NO_COLOR: ${NO_COLOR:-false}

    # Persistent storage
    volumes:
      # Server data (named volume for auth persistence)
      - hytale-data:/data
      # Machine ID for encrypted auth
      - /etc/machine-id:/etc/machine-id:ro

    # Interactive mode
    stdin_open: true
    tty: true

    # Graceful shutdown
    stop_grace_period: 30s

    # Network sysctls (performance optimization)
    sysctls:
      net.ipv4.ip_local_port_range: "1024 65535"
      net.ipv4.tcp_tw_reuse: "1"
      net.ipv4.tcp_fin_timeout: "15"
      net.core.somaxconn: "65535"
      net.ipv4.tcp_max_syn_backlog: "16384"
      net.ipv4.tcp_slow_start_after_idle: "0"

    # File descriptor limits
    ulimits:
      nofile:
        soft: 65536
        hard: 65536

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: "${CPU_LIMIT:-4}"
          memory: ${MEMORY_LIMIT:-10G}
        reservations:
          cpus: "${CPU_RESERVATION:-2}"
          memory: ${MEMORY_RESERVATION:-4G}

    # Health monitoring
    healthcheck:
      test: ["CMD", "/opt/scripts/healthcheck.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  # =============================================================================
  # Authentication Initialization (Run Once)
  # =============================================================================
  auth-init:
    build:
      context: .
      dockerfile: Dockerfile
    image: hytale-server:enterprise
    container_name: hytale-auth-init
    profiles: ["manual"]
    volumes:
      - hytale-data:/data
    environment:
      TZ: ${TZ:-UTC}
    entrypoint: ["/opt/scripts/auth-init.sh"]
    stdin_open: true
    tty: true

  # =============================================================================
  # Server Updater (Manual Update)
  # =============================================================================
  updater:
    build:
      context: .
      dockerfile: Dockerfile
    image: hytale-server:enterprise
    container_name: hytale-updater
    profiles: ["manual"]
    volumes:
      - hytale-data:/data
    environment:
      PATCHLINE: ${PATCHLINE:-release}
      TZ: ${TZ:-UTC}
    entrypoint: ["/opt/scripts/updater.sh"]

volumes:
  hytale-data:
    name: ${VOLUME_NAME:-hytale-enterprise-data}
