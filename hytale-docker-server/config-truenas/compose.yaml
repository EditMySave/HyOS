# =============================================================================
# HyOS - Hytale Server + Manager - TrueNAS SCALE Custom App
# =============================================================================
# Paste this entire file into: Apps → Discover Apps → Custom App → Install via YAML
#
# CONFIGURATION STEPS:
# 1. Create a dataset for server data (e.g., tank/apps/hytale)
# 2. Set dataset permissions: User 568, Group 568
# 3. Update the volume path below to match your dataset
# 4. Set your API_CLIENT_SECRET (password for the management API)
# 5. Adjust memory settings based on your system (minimum 8GB recommended)
#
# ACCESS:
# - Game Server: UDP port 30520
# - Management UI: http://your-truenas-ip:30300
#
# PORT CONVENTION:
# Host ports use the 30xxx range to avoid conflicts with other TrueNAS apps.
# The Hytale server default is UDP 5520 — if you are not running other apps
# that conflict, you can change the host ports back (e.g., "5520:5520/udp").
# Internal container ports (5520, 8080, 3000) are unchanged.
# =============================================================================

# ---------------------------------------------------------------------------
# Shared configuration - SET YOUR PASSWORD HERE
# ---------------------------------------------------------------------------
x-api-config: &api-config
  # REQUIRED: Set your management API password (minimum 8 characters)
  API_CLIENT_SECRET: ${API_CLIENT_SECRET:-changeme123}
  API_CLIENT_ID: ${API_CLIENT_ID:-hyos-manager}

services:
  hyos-server:
    # Use pre-built image from GHCR (published by CI)
    # Using :latest with pull_policy: always ensures restarts pull the latest image
    image: ghcr.io/editmysave/hyos/server:latest
    pull_policy: always
    container_name: hyos-server

    # Run as TrueNAS apps user (568:568) - ensure dataset matches
    user: "568:568"

    # Restart policy
    restart: unless-stopped

    # Interactive mode for OAuth authentication
    stdin_open: true
    tty: true

    # ==========================================================================
    # Environment Configuration
    # ==========================================================================
    environment:
      # Inherit shared API config
      <<: *api-config

      # --- User Settings ---
      PUID: 568
      PGID: 568
      UMASK: "002"
      TZ: ${TZ:-UTC}

      # --- JVM Memory Settings ---
      # Minimum 8G recommended, increase for larger worlds
      JAVA_XMS: ${JAVA_XMS:-8G}
      JAVA_XMX: ${JAVA_XMX:-12G}

      # --- JVM Garbage Collector ---
      USE_ZGC: "false"
      G1_MAX_PAUSE: "200"

      # --- Server Settings ---
      SERVER_PORT: "5520"
      PATCHLINE: ${PATCHLINE:-release}
      ENABLE_AOT: "true"

      # --- Auto-Update Settings ---
      # Enable automatic updates at container startup
      AUTO_UPDATE: ${AUTO_UPDATE:-false}
      # Interval for periodic update checks (seconds, default: 3600 = 1 hour)
      # AUTO_UPDATE_INTERVAL: "3600"
      # Specific time to check for updates (HH:MM format, e.g., "04:00")
      # AUTO_UPDATE_TIME: ""
      # Automatically restart server after update (default: true)
      # AUTO_UPDATE_RESTART: "true"
      # Create backup before updating (default: true)
      # AUTO_UPDATE_BACKUP: "true"

      # --- Version Check (manager UI) ---
      # Refresh version.json after auth and periodically (default: true)
      VERSION_CHECK_ENABLED: ${VERSION_CHECK_ENABLED:-true}
      # Seconds between version checks (default: 3600 = 1 hour)
      VERSION_CHECK_INTERVAL: ${VERSION_CHECK_INTERVAL:-3600}

      # --- Config Generation ---
      SKIP_CONFIG_GENERATION: "false"
      SERVER_NAME: ${SERVER_NAME:-Hytale Server}
      SERVER_MOTD: ${SERVER_MOTD:-}
      SERVER_PASSWORD: ${SERVER_PASSWORD:-}
      MAX_PLAYERS: ${MAX_PLAYERS:-100}
      MAX_VIEW_RADIUS: "32"
      DEFAULT_WORLD: ${DEFAULT_WORLD:-default}
      DEFAULT_GAMEMODE: ${DEFAULT_GAMEMODE:-Adventure}
      LOCAL_COMPRESSION: "false"
      DISPLAY_TMP_TAGS: "false"
      PLAYER_STORAGE_TYPE: "Hytale"

      # --- Whitelist ---
      WHITELIST_ENABLED: ${WHITELIST_ENABLED:-false}

      # --- Hytale Server Options ---
      HYTALE_ACCEPT_EARLY_PLUGINS: "false"
      HYTALE_ALLOW_OP: "false"
      HYTALE_BACKUP: "true"
      HYTALE_BACKUP_FREQUENCY: "30"
      HYTALE_DISABLE_SENTRY: "false"

      # --- REST API Plugin ---
      API_ENABLED: "true"
      API_PORT: "8080"
      API_WEBSOCKET_ENABLED: "true"
      API_WEBSOCKET_STATUS_INTERVAL: "1"
      # Force regenerate API config on startup to sync password from environment
      API_REGENERATE_CONFIG: "true"

      # --- Debug ---
      DEBUG: "false"
      NO_COLOR: "false"

    # Exposed ports
    ports:
      # UDP port for Hytale QUIC protocol (game traffic)
      - "30520:5520/udp"
      # HTTP port for REST API (optional - comment out if not using API)
      - "30080:8080/tcp"

    # Volume mounts
    # IMPORTANT: Update the host path to your TrueNAS dataset
    volumes:
      # Server data (world, config, mods, backups, auth)
      - /mnt/tank/apps/hytale:/data:rw

    healthcheck:
      test: ["CMD", "/opt/scripts/healthcheck.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

    # Graceful shutdown
    stop_grace_period: 30s

    # Logging - limit log size
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"

    # Security
    security_opt:
      - no-new-privileges:true

  # ===========================================================================
  # Server Manager (Web UI)
  # ===========================================================================
  hyos-manager:
    image: ghcr.io/editmysave/hyos/manager:latest
    pull_policy: always
    container_name: hyos-manager

    # Run as TrueNAS apps user
    user: "568:568"
    # Add root group for Docker socket access (socket is 0:0 with 660 permissions)
    group_add:
      - "0"

    restart: unless-stopped

    environment:
      # Inherit shared API config (same password as server)
      <<: *api-config
      # Map to REST adapter env var names
      REST_API_CLIENT_SECRET: ${API_CLIENT_SECRET:-changeme123}
      REST_API_CLIENT_ID: ${API_CLIENT_ID:-hyos-manager}

      # Adapter configuration
      ADAPTER_TYPE: rest
      HYTALE_CONTAINER_NAME: hyos-server
      HYTALE_STATE_DIR: /data/.state
      HYTALE_SERVER_HOST: hyos-server
      HYTALE_SERVER_PORT: "8080"

      # Node environment
      NODE_ENV: production
      COOKIE_SECURE: "false"

    # Web UI port
    ports:
      - "30300:3000"

    # Volume mounts
    volumes:
      # Shared data directory (for state files and world management)
      - /mnt/tank/apps/hytale:/data:rw
      # Docker socket for container control
      - /var/run/docker.sock:/var/run/docker.sock:ro

    # Depends on the Hytale server
    depends_on:
      - hyos-server

    # Health check
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    # Logging
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

    # Security - needs Docker socket access
    security_opt:
      - no-new-privileges:true

# Network configuration (use default bridge)
networks:
  default:
    driver: bridge
