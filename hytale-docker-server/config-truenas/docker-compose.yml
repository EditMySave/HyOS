# =============================================================================
# HyOS - Local Development & Testing
# =============================================================================
# Both services build from local source.
#
# Usage:
#   docker compose -f docker-compose.yml build --no-cache && docker compose -f docker-compose.yml up --force-recreate -d
#   docker compose -f docker-compose.yml logs -f    # Follow logs
#   docker compose -f docker-compose.yml down        # Stop all
#
# PORT CONVENTION:
# Host ports use the 30xxx range to avoid conflicts with other TrueNAS apps.
# The Hytale server default is UDP 5520 â€” if you are not running other apps
# that conflict, you can change the host ports back (e.g., "5520:5520/udp").
# Internal container ports (5520, 8080, 3000) are unchanged.
# =============================================================================

# Shared API config - change the password here for local testing
x-api-config: &api-config
  API_CLIENT_SECRET: test
  API_CLIENT_ID: hyos-manager

services:
  # ---------------------------------------------------------------------------
  # Hytale Server
  # ---------------------------------------------------------------------------
  hyos-server:
    build:
      context: .
      dockerfile: Dockerfile
      platforms:
        - linux/amd64
    # To use pre-built GHCR image instead of local build, comment out
    # the build block above and uncomment the line below:
    # image: ghcr.io/editmysave/hyos/server:latest
    platform: linux/amd64
    container_name: hyos-server

    ports:
      - "30520:5520/udp"
      - "30080:8080/tcp"

    environment:
      <<: *api-config
      PUID: 568
      PGID: 568
      JAVA_XMS: 8G
      JAVA_XMX: 12G
      SERVER_PORT: "5520"
      TZ: UTC
      API_ENABLED: "true"
      API_PORT: "8080"
      API_REGENERATE_CONFIG: "true"
      # Rate limits - generous for local development
      API_RATE_LIMIT: "300"
      API_RATE_BURST: "50"
      API_RATE_LIMIT_AUTH: "60"
      API_RATE_BURST_AUTH: "10"
      API_RATE_LIMIT_ADMIN: "120"
      API_RATE_BURST_ADMIN: "20"

    volumes:
      - ./data:/data

    deploy:
      resources:
        limits:
          memory: 14G
        reservations:
          memory: 8G

    stdin_open: true
    tty: true

  # ---------------------------------------------------------------------------
  # Server Manager (Web UI)
  # ---------------------------------------------------------------------------
  hyos-manager:
    build:
      context: ../../server-manager/hyos-server-manager/next
      dockerfile: Dockerfile
    # To use pre-built GHCR image instead of local build, comment out
    # the build block above and uncomment the line below:
    # image: ghcr.io/editmysave/hyos/manager:latest
    platform: linux/amd64
    container_name: hyos-manager
    # Add root group (GID 0) for Docker socket access
    # Socket inside container is 0:0 with 660 permissions
    group_add:
      - "0"

    ports:
      - "30300:3000"

    environment:
      <<: *api-config
      REST_API_CLIENT_SECRET: test
      REST_API_CLIENT_ID: hyos-manager
      ADAPTER_TYPE: rest
      HYTALE_CONTAINER_NAME: hyos-server
      HYTALE_STATE_DIR: /data/.state
      HYTALE_SERVER_HOST: hyos-server
      HYTALE_SERVER_PORT: "8080"
      REST_API_URL: http://hyos-server:8080
      NODE_ENV: production
      COOKIE_SECURE: "false"

    volumes:
      - ./data:/data:rw
      - /var/run/docker.sock:/var/run/docker.sock:ro

    depends_on:
      - hyos-server

    # Health check
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
