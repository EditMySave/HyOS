# =============================================================================
# HyOS - Local Development & Testing
# =============================================================================
# Uses GHCR images published by CI. For local source builds, uncomment the
# `build:` blocks and comment out the `image:` lines.
#
# Usage:
#   docker compose up -d          # Start both services
#   docker compose logs -f        # Follow logs
#   docker compose down           # Stop all
#
# PORT CONVENTION:
# Host ports use the 30xxx range to avoid conflicts with other TrueNAS apps.
# The Hytale server default is UDP 5520 â€” if you are not running other apps
# that conflict, you can change the host ports back (e.g., "5520:5520/udp").
# Internal container ports (5520, 8080, 3000) are unchanged.
#
# Local source build (when needed):
#   docker compose build --no-cache && docker compose up -d
# =============================================================================

# Shared API config - change the password here for local testing
x-api-config: &api-config
  API_CLIENT_SECRET: test
  API_CLIENT_ID: hyos-manager

services:
  # ---------------------------------------------------------------------------
  # Hytale Server
  # ---------------------------------------------------------------------------
  hyos-server:
    # Uncomment build block for local source builds:
    # build:
    #   context: .
    #   dockerfile: Dockerfile
    #   platforms:
    #     - linux/amd64
    image: ghcr.io/editmysave/hyos/server:latest
    platform: linux/amd64
    container_name: hyos-server

    ports:
      - "30520:5520/udp"
      - "30080:8080/tcp"

    environment:
      <<: *api-config
      PUID: 568
      PGID: 568
      JAVA_XMS: 8G
      JAVA_XMX: 12G
      SERVER_PORT: "5520"
      TZ: UTC
      API_ENABLED: "true"
      API_PORT: "8080"
      API_REGENERATE_CONFIG: "true"
      # Rate limits - generous for local development
      API_RATE_LIMIT: "300"
      API_RATE_BURST: "50"
      API_RATE_LIMIT_AUTH: "60"
      API_RATE_BURST_AUTH: "10"
      API_RATE_LIMIT_ADMIN: "120"
      API_RATE_BURST_ADMIN: "20"

    volumes:
      - ./data:/data

    deploy:
      resources:
        limits:
          memory: 14G
        reservations:
          memory: 8G

    stdin_open: true
    tty: true

  # ---------------------------------------------------------------------------
  # Server Manager (Web UI)
  # ---------------------------------------------------------------------------
  hyos-manager:
    # Uncomment build block for local source builds:
    # build:
    #   context: ../../server-manager/hyos-server-manager/next
    #   dockerfile: Dockerfile
    image: ghcr.io/editmysave/hyos/manager:latest
    platform: linux/amd64
    container_name: hyos-manager
    # Add root group (GID 0) for Docker socket access
    # Socket inside container is 0:0 with 660 permissions
    group_add:
      - "0"

    ports:
      - "30300:3000"

    environment:
      <<: *api-config
      REST_API_CLIENT_SECRET: test
      REST_API_CLIENT_ID: hyos-manager
      ADAPTER_TYPE: rest
      HYTALE_CONTAINER_NAME: hyos-server
      HYTALE_STATE_DIR: /data/.state
      HYTALE_SERVER_HOST: hyos-server
      HYTALE_SERVER_PORT: "8080"
      REST_API_URL: http://hyos-server:8080
      NODE_ENV: production

    volumes:
      - ./data:/data:rw
      - /var/run/docker.sock:/var/run/docker.sock:ro

    depends_on:
      - hyos-server
